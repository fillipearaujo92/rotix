<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Otimizador de Rotas</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    #map { height: calc(100vh - 160px); width: 100%; }
    .leaflet-popup-content button {
      margin: 4px 2px;
      padding: 4px 8px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .leaflet-popup-content .delivered { background: #10b981; color: white; }
    .leaflet-popup-content .notdelivered { background: #ef4444; color: white; }
    .leaflet-popup-content .pending { background: #f59e0b; color: white; }

    /* Toast notification */
    .toast {
      position: fixed;
      top: 60px;
      right: 20px;
      background: #1f2937;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
    }
    .toast.show { transform: translateX(0); }

    #menuToggleBtn {
  position: fixed; /* garante que não role com a tela */
  z-index: 9999;   /* acima de qualquer camada do Leaflet */
}

  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <i class="fas fa-info-circle mr-2"></i>
    <span id="toastMessage"></span>
  </div>

  <!-- Botão hambúrguer -->
<button id="menuToggleBtn" class="top-4 left-4 bg-white shadow rounded-lg p-2">
  <i class="fas fa-bars text-xl text-gray-700"></i>
</button>


  <!-- Overlay -->
  <div id="menuOverlay" class="hidden fixed inset-0 bg-black bg-opacity-40 z-40"></div>

  <!-- Menu retrátil -->
  <div id="sideMenu" class="hidden fixed top-0 left-0 w-80 h-full bg-white shadow-2xl z-50 p-6 overflow-y-auto transform -translate-x-full transition-transform duration-300" style="z-index: 9999;">
    <div class="flex justify-between items-center mb-4">
      <h4 class="font-semibold text-gray-800">
        <i class="fas fa-list mr-2"></i>Lista de Entregas
      </h4>
      <button id="closeMenuBtn" class="text-gray-500 hover:text-red-500">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <div id="routeList"></div>
  </div>

  <!-- Etapa 1: Upload -->
  <div id="step1" class="flex-1 flex flex-col items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-lg p-10 w-full max-w-md text-center">
      <h1 class="text-2xl font-bold text-indigo-600 mb-4">
        <i class="fas fa-truck mr-2"></i>Otimizador de Rotas
      </h1>
      <p class="text-gray-600 mb-6">Carregue seu arquivo XLSX para começar</p>
      <label for="fileInput" class="cursor-pointer block border-2 border-dashed border-indigo-400 rounded-xl p-10 hover:bg-indigo-50 transition">
        <i class="fas fa-file-excel text-3xl text-indigo-600 mb-3 block"></i>
        <span class="text-indigo-600 font-semibold">Clique ou arraste seu arquivo aqui</span>
        <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden"/>
      </label>
    </div>
  </div>

  <!-- Etapa 2: Seleção de colunas -->
  <div id="step2" class="hidden flex-1 flex flex-col items-center justify-center p-6">
    <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-md">
      <h2 class="text-xl font-bold text-indigo-600 mb-4">
        <i class="fas fa-list-check mr-2"></i>Selecione as informações
      </h2>
      <p class="text-gray-500 mb-4 text-sm">Escolha os campos que deseja visualizar durante as entregas</p>
      <div id="columnsList" class="space-y-3 mb-6"></div>
      <button id="confirmColumnsBtn" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-semibold hover:bg-indigo-700 transition">
        <i class="fas fa-check mr-2"></i>Confirmar
      </button>
    </div>
  </div>

  <!-- Etapa 3: Mapa -->
  <div id="step3" class="hidden flex-1 flex flex-col">
    <div id="map"></div>
    
    <!-- Barra inferior de próxima parada -->
    <div id="nextStopBar" class="hidden fixed bottom-0 left-0 right-0 bg-white rounded-t-2xl shadow-2xl z-50 p-4">
      <div class="flex justify-between items-center">
        <div>
          <h3 class="font-semibold text-gray-800">
            <i class="fas fa-route mr-2 text-indigo-600"></i>Próxima Parada
          </h3>
          <div id="nextStopInfo" class="text-sm text-gray-700"></div>
        </div>
        <div class="flex space-x-2">
          <button class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow" onclick="markNext('entregue')">
            ✅
          </button>
          <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow" onclick="markNext('naoentregue')">
            ❌
          </button>
          <button class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg shadow" onclick="markNext('pendente')">
            ⏸️
          </button>
        </div>
      </div>
    </div>
  </div>

<script>
let deliveryData=[], userLocation=null, map, markers=[], routeLayer, userMarker;
let selectedColumns=[]; 

// ==== Upload ====
document.getElementById('fileInput').addEventListener('change', handleFileUpload);
document.getElementById('confirmColumnsBtn')?.addEventListener('click', () => {
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.remove('hidden');
  optimizeRoute();
});

// ==== Geolocalização ====
navigator.geolocation.getCurrentPosition(pos=>{
  userLocation={lat:pos.coords.latitude,lng:pos.coords.longitude};
},()=>{userLocation={lat:-23.55,lng:-46.63}});

// ==== Upload Excel ====
function handleFileUpload(e){
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=function(ev){
    const data=new Uint8Array(ev.target.result);
    const wb=XLSX.read(data,{type:'array'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    deliveryData=XLSX.utils.sheet_to_json(sheet);
    deliveryData.forEach((d,i)=>{ d.status="pendente"; d.Sequence=i+1; });

    const cols=Object.keys(deliveryData[0]||{});
    const container=document.getElementById("columnsList");
    container.innerHTML=cols.map(c=>`
      <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
        <input type="checkbox" value="${c}" class="columnChk text-indigo-600"/>
        <span>${c}</span>
      </label>`).join('');

    document.getElementById('step1').classList.add('hidden');
    document.getElementById('step2').classList.remove('hidden');
  };
  reader.readAsArrayBuffer(file);
}

// ==== Toast Notification ====
function showToast(message, duration = 3000) {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  toastMessage.textContent = message;
  toast.classList.add('show');
  setTimeout(() => { toast.classList.remove('show'); }, duration);
}

// ==== Distância ====
function haversine(a,b){const toRad=d=>d*Math.PI/180,R=6371;
  const dLat=toRad(b.lat-a.lat),dLon=toRad(b.lng-a.lng);
  const lat1=toRad(a.lat),lat2=toRad(b.lat);
  const h=Math.sin(dLat/2)**2+Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  return 2*R*Math.asin(Math.sqrt(h));}

// ==== Otimização ====
function optimizeRoute(){
  if(!deliveryData.length)return;
  let start=0,best=Infinity;
  deliveryData.forEach((d,i)=>{
    const dist=haversine(userLocation,{lat:+d.Latitude,lng:+d.Longitude});
    if(dist<best){best=dist;start=i;}
  });
  const unvisited=deliveryData.map((_,i)=>i);
  let order=[],current=start;
  while(unvisited.length){
    order.push(current); unvisited.splice(unvisited.indexOf(current),1);
    if(!unvisited.length) break;
    let bestIdx=unvisited[0],min=Infinity;
    unvisited.forEach(i=>{
      const dist=haversine({lat:+deliveryData[current].Latitude,lng:+deliveryData[current].Longitude},{lat:+deliveryData[i].Latitude,lng:+deliveryData[i].Longitude});
      if(dist<min){min=dist;bestIdx=i;}
    });
    current=bestIdx;
  }
  deliveryData=order.map((i,idx)=>({...deliveryData[i],Sequence:idx+1,status:deliveryData[i].status}));
  initMap();
  updateUI();
  startTracking();
  showToast(`Rota otimizada com ${deliveryData.length} entregas!`, 4000);
}

// ==== Inicializar mapa ====
function initMap(){
  if(!map){
    map=L.map('map').setView([userLocation.lat,userLocation.lng],13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
  }
}

// ==== Atualizar estatísticas e UI ====
function updateUI(){
  updateMarkers();
  showNextStop();
  drawNextRoute();

  document.getElementById('routeList').innerHTML=deliveryData.map(d=>{
    let bg=d.status==="entregue"?"bg-green-50 border-green-200":d.status==="naoentregue"?"bg-red-50 border-red-200":"bg-yellow-50 border-yellow-200";
    let text=d.status==="entregue"?"text-green-700":d.status==="naoentregue"?"text-red-700":"text-yellow-700";
    let icon=d.status==="entregue"?"fas fa-check-circle":d.status==="naoentregue"?"fas fa-times-circle":"fas fa-clock";
    
    return `<div class="p-3 rounded-lg mb-2 border ${bg} flex justify-between items-center">
              <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center text-xs font-bold">
                  ${d.Sequence}
                </div>
                <span class="text-sm">${d['Destination Address']||'Sem endereço'}</span>
              </div>
              <div class="flex items-center space-x-2">
                <i class="${icon} ${text}"></i>
                <span class="${text} font-medium capitalize text-xs">${d.status.replace('naoentregue', 'não entregue')}</span>
              </div>
            </div>`;
  }).join('');
}

// ==== Marcadores ====
function updateMarkers(){
  markers.forEach(m=>map.removeLayer(m)); markers=[];
  const next=deliveryData.find(d=>d.status==="pendente");
  deliveryData.forEach(d=>{
    let color=d.status==="entregue"?"green":d.status==="naoentregue"?"red":"blue";
    let size=28;
    if(next && d.Sequence===next.Sequence && d.status==="pendente"){ color="orange"; size=36; }
    const icon=L.divIcon({className:'',html:`<div style="background:${color};color:white;border-radius:50%;width:${size}px;height:${size}px;display:flex;align-items:center;justify-content:center;font-size:12px;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.2)">${d.Sequence}</div>`});
    const mk=L.marker([+d.Latitude,+d.Longitude],{icon}).addTo(map);
    mk.bindPopup(`<b>Parada ${d.Sequence}</b><br>${d['Destination Address']||''}<br>
      <button class="delivered" onclick="changeStatus(${d.Sequence},'entregue')"><i class="fas fa-check"></i></button>
      <button class="notdelivered" onclick="changeStatus(${d.Sequence},'naoentregue')"><i class="fas fa-times"></i></button>
      <button class="pending" onclick="changeStatus(${d.Sequence},'pendente')"><i class="fas fa-pause"></i></button>`);
    markers.push(mk);
  });
}

// ==== Barra próxima parada ====
function showNextStop(){
  const next=deliveryData.find(d=>d.status==="pendente");
  if(!next){
    document.getElementById('nextStopBar').classList.add("hidden");
    showToast("🎉 Todas as entregas foram processadas!");
    return;
  }
  document.getElementById('nextStopBar').classList.remove("hidden");

  selectedColumns=[...document.querySelectorAll(".columnChk:checked")].map(c=>c.value);
  let extraInfo=selectedColumns.map(c=>`<i class="fas fa-info-circle mr-1"></i>${c}: ${next[c]||''}`).join("<br>");

  document.getElementById('nextStopInfo').innerHTML=`
    <div class="flex flex-col space-y-1">
      <div class="font-medium text-gray-800">${next['Destination Address']||'Sem endereço'}</div>
      <div class="text-xs text-gray-500 mt-1">${extraInfo}</div>
    </div>
  `;
}

// ==== Rota até próxima parada ====
async function drawNextRoute(){
  const next=deliveryData.find(d=>d.status==="pendente");
  if(!next) return;
  const coords=`${userLocation.lng},${userLocation.lat};${next.Longitude},${next.Latitude}`;
  const url=`https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
  const res=await fetch(url);
  const data=await res.json();
  if(data.routes && data.routes.length){
    if(routeLayer) map.removeLayer(routeLayer);
    routeLayer=L.geoJSON(data.routes[0].geometry,{style:{color:"#f59e0b",weight:6}}).addTo(map);
  }
}

// ==== Localização em tempo real ====
function startTracking() {
  if (!navigator.geolocation) return;
  navigator.geolocation.watchPosition(pos => {
    const { latitude, longitude } = pos.coords;
    userLocation = { lat: latitude, lng: longitude };

    if (!userMarker) {
      const pulseIcon = L.divIcon({
        className: "",
        html: `<div class="relative"><div class="w-6 h-6 bg-blue-500 rounded-full border-4 border-white"></div><div class="absolute inset-0 rounded-full bg-blue-400 opacity-50 animate-ping"></div></div>`
      });
      userMarker = L.marker([latitude, longitude], { icon: pulseIcon }).addTo(map).bindPopup("📍 Você está aqui");
    } else {
      userMarker.setLatLng([latitude, longitude]);
    }
    drawNextRoute();
  }, err => console.error(err), { enableHighAccuracy: true });
}

// ==== Status ====
function markNext(status){
  const next=deliveryData.find(d=>d.status==="pendente");
  if(next){
    next.status=status; 
    updateUI();
    const messages = {
      'entregue': '✅ Entrega realizada!',
      'naoentregue': '❌ Entrega não realizada',
      'pendente': '⏸️ Entrega como pendente'
    };
    showToast(messages[status]);
  }
}

function changeStatus(seq,status){
  const stop=deliveryData.find(d=>d.Sequence===seq);
  if(stop){stop.status=status; updateUI();}
}

// ==== Menu lateral ====
const menuBtn = document.getElementById("menuToggleBtn");
const sideMenu = document.getElementById("sideMenu");
const overlay = document.getElementById("menuOverlay");
const closeBtn = document.getElementById("closeMenuBtn");

function toggleMenu(force = null) {
  const isOpen = !sideMenu.classList.contains("hidden");
  const shouldOpen = force !== null ? force : !isOpen;

  if (shouldOpen) {
    sideMenu.classList.remove("hidden");
    overlay.classList.remove("hidden");
    setTimeout(() => sideMenu.classList.remove("-translate-x-full"), 10);
  } else {
    sideMenu.classList.add("-translate-x-full");
    overlay.classList.add("hidden");
    setTimeout(() => sideMenu.classList.add("hidden"), 300);
  }
}

menuBtn.addEventListener("click", () => toggleMenu());
closeBtn.addEventListener("click", () => toggleMenu(false));
overlay.addEventListener("click", () => toggleMenu(false));
</script>
</body>
</html>
