<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Rotix - Otimizador de Rotas</title>
  <link rel="icon" type="image/png" href="img/favicon.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    :root { --rotix-blue: #5e33ea; }
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap' );
    body { font-family: 'Inter', sans-serif; }
    #map { height: 100vh; }
    .leaflet-control-zoom, .leaflet-control-attribution { display: none !important; }
    .leaflet-popup-content-wrapper { border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .leaflet-popup-content { margin: 15px; font-size: 14px; line-height: 1.6; }
    .leaflet-popup-content b { font-weight: 600; }
    .leaflet-popup-content small { color: #555; }
    .leaflet-popup-tip { box-shadow: none; }

    .toast {
      position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(5px);
      color: white; padding: 12px 20px; border-radius: 25px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); z-index: 10001;
      display: none; align-items: center;
      z-index: 9999;
    }
    .toast.show { display: flex; animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -20px); } to { opacity: 1; transform: translate(-50%, 0); } }

    .map-floating-btn {
      position: fixed; z-index: 1000; background-color: white;
      width: 48px; height: 48px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2); cursor: pointer;
      transition: all 0.2s ease;
    }
    .map-floating-btn:hover { transform: scale(1.05); }
    #menuToggleBtn { top: 20px; left: 20px; box-shadow: 5px 5px 20px rgba(0,0,0,0.5); cursor: pointer;}
    #centerUserBtn { bottom: 200px; right: 20px; border: 5px solid white; box-shadow: 5px 5px 20px rgba(0,0,0,0.5); cursor: pointer;}
    #reOptimizeBtn { bottom: 260px; right: 20px; background: linear-gradient(135deg, #5e33ea, #8b5cf6); color: rgb(255, 255, 255); border: 3px solid #eeeeee; box-shadow: 5px 5px 20px rgba(0,0,0,0.5); cursor: pointer;}
    #sideMenu {
        z-index: 9999;
    }

    /* Estilos para o Modal de Progresso */
#progressModal.hidden {
  display: none;
}

/* Anima√ß√£o do Spinner (Loader) */
.loader {
  border: 5px solid #f3f3f3; /* Cinza claro */
  border-top: 5px solid #5e33ea; /* Roxo Rotix */
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
  </style>
</head>
<body class="bg-gray-100">

  <!-- Toast Notification -->
  <div id="toast" class="toast">
    <i id="toastIcon" class="fas fa-info-circle mr-3"></i>
    <span id="toastMessage"></span>
  </div>

  <!-- Modal de Progresso da Otimiza√ß√£o -->
    <div id="progressModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-lg p-8 flex flex-col items-center space-y-4 w-64">
            <div class="loader"></div>
            <h3 class="text-gray-700 font-semibold text-lg">Otimizando Rota...</h3>
            <p id="progressText" class="text-gray-500 text-sm">Calculando dist√¢ncias...</p>
        </div>
    </div>

    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[9999] flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-lg p-6 flex flex-col w-full max-w-sm">
        <div class="flex items-center mb-4">
        <i class="fas fa-exclamation-triangle text-yellow-500 text-2xl mr-4"></i>
        <h3 id="confirmTitle" class="text-gray-800 font-bold text-lg">Aten√ß√£o</h3>
        </div>
        <p id="confirmMessage" class="text-gray-600 text-sm mb-6">Deseja continuar com esta a√ß√£o?</p>
        <div class="flex justify-end space-x-3">
        <button id="confirmCancelBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-5 rounded-lg transition-colors">Cancelar</button>
        <button id="confirmOkBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-5 rounded-lg transition-colors">OK</button>
        </div>
    </div>
    </div>

  <!-- Bot√µes Flutuantes do Mapa -->
  <button id="menuToggleBtn" class="map-floating-btn hidden">
    <i class="fas fa-bars text-xl text-gray-700"></i>
  </button>
  <button id="centerUserBtn" class="map-floating-btn hidden">
    <i class="fas fa-location-crosshairs text-xl text-blue-500"></i>
  </button>
  <button id="reOptimizeBtn" class="map-floating-btn hidden" title="Reotimizar Rota a partir da sua localiza√ß√£o">
    <i class="fas fa-route text-xl"></i>
  </button>

  <!-- Menu Lateral -->
<div id="menuOverlay" class="hidden fixed inset-0 bg-black bg-opacity-40 z-4000"></div>
<div id="sideMenu" class="hidden fixed top-0 left-0 w-full max-w-sm h-full bg-white shadow-2xl z-5000 p-6 overflow-y-auto transform -translate-x-full transition-transform duration-300">
  <div class="flex justify-between items-center mb-6">
    <h4 class="font-semibold text-gray-800 text-lg"><i class="fas fa-list mr-2"></i>Lista de Entregas</h4>
    <button id="closeMenuBtn" class="text-gray-500 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
  </div>
  
  <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
    <h5 class="font-medium text-red-800 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>Recome√ßar Rota</h5>
    <p class="text-sm text-red-600 mb-3">Isso apagar√° a rota atual e voltar√° ao in√≠cio.</p>
    <button id="loadNewFileBtn" class="w-full bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-medium transition"><i class="fas fa-file-upload mr-2"></i>Carregar Novo Arquivo</button>
  </div>

  <!-- SE√á√ÉO DE CONFIGURA√á√ïES DE ROTA FOI REMOVIDA -->
  
  <div class="mb-6 p-4 bg-indigo-50 border border-indigo-200 rounded-lg">
    <h5 class="font-medium text-indigo-800 mb-2"><i class="fas fa-chart-bar mr-2"></i>Estat√≠sticas</h5>
    <div id="routeStats" class="text-sm text-indigo-700"></div>
  </div>
  
  <div id="routeList"></div>
</div>


  <!-- Etapa 1: Upload -->
  <div id="step1" class="flex-1 flex flex-col items-center justify-center p-6 min-h-screen">
    <div class="bg-white rounded-2xl shadow-lg p-10 w-full max-w-md text-center">
      <div class="w-20 h-20 mx-auto mb-6 bg-gradient-to-br from-[var(--rotix-blue)] to-purple-800 rounded-3xl flex items-center justify-center">
        <img src="img/logo.svg" width="45">
        </div>
      <h1 class="text-4xl font-bold tracking-widest text-gray-800">Rotix</h1>
      <h3 class="text-xs tracking-widest text-gray-500 mb-8">Intelig√™ncia em movimento</h3>
      <label for="fileInput" class="cursor-pointer block border-2 border-dashed border-indigo-400 rounded-xl p-10 hover:bg-indigo-50 transition">
        <i class="fas fa-file-excel text-4xl text-indigo-500 mb-4 block"></i>
        <span class="text-indigo-600 font-semibold">Clique ou arraste seu arquivo</span>
        <input type="file" id="fileInput" accept=".xlsx,.xls" class="hidden"/>
      </label>
    </div>
  </div>

  <!-- Etapa 2: Sele√ß√£o de colunas -->
  <div id="step2" class="hidden flex-1 flex flex-col items-center justify-center p-6 min-h-screen">
    <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-md">
      <h2 class="text-xl font-bold text-indigo-600 mb-4"><i class="fas fa-list-check mr-2"></i>Selecione as Informa√ß√µes</h2>
      <p class="text-gray-500 mb-6 text-sm">Escolha os campos que deseja visualizar nos detalhes da entrega.</p>
      <div id="columnsList" class="space-y-3 mb-6 max-h-60 overflow-y-auto"></div>
      <button id="confirmColumnsBtn" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition"><i class="fas fa-check mr-2"></i>Confirmar e Otimizar</button>
    </div>
  </div>

  <!-- Etapa 3: Mapa -->
  <div id="step3" class="hidden">
    <div id="map"></div>
    <div id="nextStopBar" class="hidden fixed bottom-0 left-0 right-0 bg-white shadow-[0_-5px_20px_rgba(0,0,0,0.1)] rounded-t-2xl z-[1001] p-4">
        <div class="w-full max-w-4xl mx-auto">
            <div class="flex justify-between items-start mb-3">
            <div id="nextStopInfo" class="text-gray-800 mr-4"></div>
            </div>
            <!-- MODIFICA√á√ÉO: grid-cols-3 para grid-cols-4 e adi√ß√£o do bot√£o Pendente -->
            <div class="grid grid-cols-4 gap-2">
                <button onclick="openNavigation()" class="col-span-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center text-xs"><i class="fas fa-diamond-turn-right mr-2"></i>Navegar</button>
                
                <button id="entregueBtn" onclick="markNext('entregue')" class="col-span-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg flex items-center justify-center text-xs">
                    <i class="fas fa-check-double mr-2 text-green-500"></i>
                    <span id="entregueText">Entregue</span>
                </button>

                <button id="naoEntregueBtn" onclick="markNext('naoentregue')" class="col-span-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg flex items-center justify-center text-xs">
                    <i class="fas fa-box mr-2 text-red-500"></i>
                    <span id="naoEntregueText">N√£o Entregue</span>
                </button>
                
                <!-- NOVO BOT√ÉO PENDENTE -->
                <button onclick="markNext('pendente')" class="col-span-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg flex items-center justify-center text-xs">
                    <i class="fas fa-clock mr-2 text-yellow-500"></i>
                    <span>Pendente</span>
                </button>
            </div>
        </div>
    </div>

  </div>

<script>
// =================================================================================
// VARI√ÅVEIS GLOBAIS
// =================================================================================
let deliveryData = [], userLocation = null, map, markers = [], routeLayer, nextDeliveryRouteLayer, userMarker;
let selectedColumns = [];
let startPoint = null;
let endPoint = null;
let isRouteOptimized = false;

// =================================================================================
// INICIALIZA√á√ÉO E GERENCIAMENTO DE ESTADO
// =================================================================================
window.addEventListener('load', () => {
  loadSavedState();
  initGeolocation();
});

function saveState() {
  try {
    const stateToSave = {
      deliveryData: deliveryData,
      selectedColumns: selectedColumns,
      startPoint: startPoint,
      endPoint: endPoint,
      currentStep: getCurrentStep(),
      isRouteOptimized: isRouteOptimized // <-- ADICIONAR ESTA LINHA
    };
    localStorage.setItem('routeOptimizerState', JSON.stringify(stateToSave));
  } catch (e) { console.error('Erro ao salvar estado:', e); }
}


async function loadSavedState() { // <-- TORNAR A FUN√á√ÉO ASYNC
  const savedState = localStorage.getItem('routeOptimizerState');
  if (!savedState) return;
  try {
    const state = JSON.parse(savedState);
    if (state.currentStep === 'step3' && state.deliveryData?.length > 0) {
      deliveryData = state.deliveryData;
      selectedColumns = state.selectedColumns || [];
      startPoint = state.startPoint;
      endPoint = state.endPoint;
      isRouteOptimized = state.isRouteOptimized || false; // <-- RESTAURAR O ESTADO DE OTIMIZA√á√ÉO

      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step3').classList.remove('hidden');
      
      showMapControls(true);
      await initGeolocation(); // Espera a geolocaliza√ß√£o para ter o userLocation
      initMap();

      // --- SOLU√á√ÉO: DESENHA A ROTA COMPLETA AO RECARREGAR ---
      if (isRouteOptimized) {
        if (routeLayer) map.removeLayer(routeLayer);
        const allPoints = deliveryData.map(d => ({ lat: +d.Latitude, lng: +d.Longitude }));
        if (userLocation) allPoints.unshift(userLocation); // Adiciona a localiza√ß√£o atual ao tra√ßado
        
        routeLayer = await drawRoute(allPoints, { style: { color: "#5e33ea", weight: 5, opacity: 0.7 } });
        if (routeLayer) {
          routeLayer.addTo(map);
          // Ajusta o zoom para a rota completa
          setTimeout(() => map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] }), 500);
        }
      }
      // --- FIM DA SOLU√á√ÉO ---

      updateUI();
      startTracking();
      showToast('Rota anterior restaurada!', 'success');
    }
  } catch (e) {
    console.error('Erro ao carregar estado:', e);
    clearState();
  }
}


function clearState() {
  localStorage.removeItem('routeOptimizerState');
  window.location.reload();
}

function getCurrentStep() {
  if (!document.getElementById('step1').classList.contains('hidden')) return 'step1';
  if (!document.getElementById('step2').classList.contains('hidden')) return 'step2';
  if (!document.getElementById('step3').classList.contains('hidden')) return 'step3';
  return null;
}

// =================================================================================
// UPLOAD DE ARQUIVO E PREPARA√á√ÉO
// =================================================================================
document.getElementById('fileInput').addEventListener('change', handleFileUpload);

function handleFileUpload(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (event) => {
    try {
      const data = new Uint8Array(event.target.result);
      const workbook = XLSX.read(data, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      
      const jsonData = XLSX.utils.sheet_to_json(worksheet, {
        header: 1,
        transformHeader: (header) => header.trim()
      });

      const headers = jsonData.shift();
      const rows = jsonData;

      const cleanJsonData = rows.map(row => {
        const obj = {};
        headers.forEach((header, index) => {
          obj[header] = row[index];
        });
        return obj;
      });

      if (cleanJsonData.length === 0) return showToast('Arquivo vazio ou formato inv√°lido', 'error');

      const firstRowKeys = Object.keys(cleanJsonData[0]);
      const stopHeader = firstRowKeys.find(key => key.toUpperCase() === 'STOP');
      const latHeader = firstRowKeys.find(key => key.toUpperCase() === 'LATITUDE');
      const lngHeader = firstRowKeys.find(key => key.toUpperCase() === 'LONGITUDE');

      if (!latHeader || !lngHeader) {
        return showToast('Arquivo deve conter colunas "Latitude" e "Longitude"', 'error');
      }
      if (!stopHeader) {
        return showToast('Arquivo deve conter uma coluna chamada "STOP"', 'error');
      }

      deliveryData = cleanJsonData.map((row, index) => ({
        ...row,
        Latitude: row[latHeader],
        Longitude: row[lngHeader],
        STOP: row[stopHeader],
        id: index,
        status: "pendente",
      }));
      
      const cols = Object.keys(deliveryData[0]).filter(c => !['id', 'status', 'Latitude', 'Longitude'].includes(c));
      
      const container = document.getElementById("columnsList");
      container.innerHTML = cols.map(c => `
        <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-50 p-2 rounded-lg">
          <input type="checkbox" value="${c}" class="columnChk h-5 w-5 text-indigo-600 border-gray-300 rounded" ${['Cliente', 'Endere√ßo', 'Destination Address', 'Telefone', 'Observa√ß√£o'].includes(c) ? 'checked' : ''}/>
          <span class="text-gray-700">${c}</span>
        </label>`).join('');

      document.getElementById('step1').classList.add('hidden');
      document.getElementById('step2').classList.remove('hidden');
      showToast(`${deliveryData.length} entregas carregadas!`, 'success');
    } catch (error) {
      console.error('Erro ao processar arquivo:', error);
      showToast('Erro ao processar o arquivo. Verifique o formato.', 'error');
    }
  };
  reader.readAsArrayBuffer(file);
}

document.getElementById('confirmColumnsBtn')?.addEventListener('click', () => {
  selectedColumns = [...document.querySelectorAll(".columnChk:checked")].map(c => c.value);
  document.getElementById('step2').classList.add('hidden');
  document.getElementById('step3').classList.remove('hidden');
  
  showMapControls(true);
  initMap();
  optimizeRoute();
});

// =================================================================================
// GEOLOCALIZA√á√ÉO E GEOCODIFICA√á√ÉO (Nominatim/OSM)
// =================================================================================
function initGeolocation() {
  return new Promise((resolve) => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => { 
          userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
          resolve();
        },
        () => { 
            userLocation = { lat: -3.73186, lng: -38.5267 }; // Fallback
            showToast('Usando localiza√ß√£o padr√£o. Permita o acesso para maior precis√£o.', 'warn');
            resolve();
        }
      );
    } else {
      userLocation = { lat: -3.73186, lng: -38.5267 }; // Fallback
      showToast('Geolocaliza√ß√£o n√£o suportada por este navegador.', 'error');
      resolve();
    }
  });
}


async function geocodeAddress(address) {
  if (!address) return null;
  try {
    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address )}&countrycodes=br&limit=1`);
    const data = await response.json();
    if (data && data.length > 0) {
      return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), address: data[0].display_name };
    }
    return null;
  } catch (error) {
    console.error('Erro na geocodifica√ß√£o:', error);
    return null;
  }
}

// =================================================================================
// OTIMIZA√á√ÉO E ROTEAMENTO (OSRM)
// =================================================================================

const delay = ms => new Promise(res => setTimeout(res, ms));

// ADICIONADO 'async' AQUI
async function optimizeRoute() {
  if (deliveryData.length === 0) return showToast('Nenhuma entrega para otimizar', 'warn');

  const optimizeBtn = document.getElementById('reOptimizeBtn');
  optimizeBtn.disabled = true;
  optimizeBtn.classList.add('opacity-50', 'cursor-not-allowed');

  showProgressModal('Iniciando otimiza√ß√£o...', 0);
  await delay(50);

  let currentStartPoint = userLocation;
  if (!currentStartPoint) {
    currentStartPoint = { lat: deliveryData[0].Latitude, lng: deliveryData[0].Longitude };
    showToast('Localiza√ß√£o n√£o encontrada. Iniciando da primeira entrega.', 'warn');
  }

  deliveryData.forEach(d => d.status = "pendente");

  let unvisited = [...deliveryData];
  let orderedRoute = [];
  let currentPoint = currentStartPoint;
  const totalStops = unvisited.length;

  while (unvisited.length > 0) {
    let nearestIndex = -1;
    let minDistance = Infinity;
    unvisited.forEach((stop, index) => {
      const dist = haversine(currentPoint, { lat: stop.Latitude, lng: stop.Longitude });
      if (dist < minDistance) {
        minDistance = dist;
        nearestIndex = index;
      }
    });
    const nextStop = unvisited.splice(nearestIndex, 1)[0];
    orderedRoute.push(nextStop);
    currentPoint = { lat: nextStop.Latitude, lng: nextStop.Longitude };

    const progress = ((totalStops - unvisited.length) / totalStops) * 100;
    showProgressModal(`Processando parada ${totalStops - unvisited.length} de ${totalStops}...`, progress);
    await delay(10);
  }

  deliveryData = orderedRoute.map((d, i) => ({ ...d, Sequence: i + 1 }));
  isRouteOptimized = true;

  hideProgressModal();
  showToast(`Rota otimizada com ${deliveryData.length} entregas!`, 'success');

  if (routeLayer) map.removeLayer(routeLayer); // Limpa a rota antiga se existir
  const allPoints = deliveryData.map(d => ({ lat: +d.Latitude, lng: +d.Longitude }));
  // Adiciona o ponto de partida ao in√≠cio para o tra√ßado
  if (userLocation) allPoints.unshift(userLocation);
  
  routeLayer = await drawRoute(allPoints, { style: { color: "#5e33ea", weight: 5, opacity: 0.7 } });
  if (routeLayer) routeLayer.addTo(map);

  optimizeBtn.disabled = false;
  optimizeBtn.classList.remove('opacity-50', 'cursor-not-allowed');

  saveState();
  updateUI();
  startTracking();

  setTimeout(() => {
    if (routeLayer) map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
  }, 500);
}

// ADICIONADO 'async' AQUI
async function reOptimizeFromCurrentLocation() {
  if (!userLocation) return showToast('Localiza√ß√£o atual n√£o encontrada.', 'error');
  const pendingDeliveries = deliveryData.filter(d => d.status === 'pendente');
  if (pendingDeliveries.length < 2) return showToast('N√£o h√° entregas suficientes para reotimizar.', 'info');

  if (isRouteOptimized) {
    const confirmed = await showConfirmModal(
      "‚ö†Ô∏è Rota j√° otimizada!",
      "Deseja criar uma nova otimiza√ß√£o a partir da sua localiza√ß√£o atual? A ordem das entregas pendentes ser√° recalculada."
    );
    if (!confirmed) return;
  }

  const optimizeBtn = document.getElementById('reOptimizeBtn');
  optimizeBtn.disabled = true;
  optimizeBtn.classList.add('opacity-50', 'cursor-not-allowed');

  showProgressModal('Reotimizando a partir da sua localiza√ß√£o...', 0);
  await delay(50);

  let unvisited = [...pendingDeliveries];
  let reorderedRoute = [];
  let currentPoint = userLocation;
  const totalStops = unvisited.length;

  while (unvisited.length > 0) {
    let nearestIndex = -1;
    let minDistance = Infinity;
    unvisited.forEach((stop, index) => {
      const dist = haversine(currentPoint, { lat: stop.Latitude, lng: stop.Longitude });
      if (dist < minDistance) {
        minDistance = dist;
        nearestIndex = index;
      }
    });
    const nextStop = unvisited.splice(nearestIndex, 1)[0];
    reorderedRoute.push(nextStop);
    currentPoint = { lat: nextStop.Latitude, lng: nextStop.Longitude };

    const progress = ((totalStops - unvisited.length) / totalStops) * 100;
    showProgressModal(`Processando parada ${totalStops - unvisited.length} de ${totalStops}...`, progress);
    await delay(10);
  }

  const completedDeliveries = deliveryData.filter(d => d.status !== 'pendente');
  const finalRoute = [...completedDeliveries, ...reorderedRoute];
  deliveryData = finalRoute.map((d, i) => ({ ...d, Sequence: i + 1 }));
  isRouteOptimized = true;

  hideProgressModal();
  showToast('Rota reotimizada com sucesso!', 'success');

  if (routeLayer) map.removeLayer(routeLayer);
  const allPoints = deliveryData
    .filter(d => d.status === 'pendente') // Pega apenas as pendentes para o novo tra√ßado
    .map(d => ({ lat: +d.Latitude, lng: +d.Longitude }));
  if (userLocation) allPoints.unshift(userLocation);

  routeLayer = await drawRoute(allPoints, { style: { color: "#5e33ea", weight: 5, opacity: 0.7 } });
  if (routeLayer) routeLayer.addTo(map);

  optimizeBtn.disabled = false;
  optimizeBtn.classList.remove('opacity-50', 'cursor-not-allowed');

  saveState();
  updateUI();

  setTimeout(() => {
    if (routeLayer) map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
  }, 1000);
}


async function drawRoute(points, options) {
  if (points.length < 2) return null;
  const coords = points.map(p => `${p.lng},${p.lat}`).join(';');
  const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=full&geometries=geojson`;
  try {
    const res = await fetch(url );
    const data = await res.json();
    if (data.routes && data.routes.length) {
      return L.geoJSON(data.routes[0].geometry, { style: options.style });
    }
  } catch (error) { console.error('Erro ao desenhar rota OSRM:', error); }
  return null;
}

// =================================================================================
// ATUALIZA√á√ÉO DA INTERFACE (UI)
// =================================================================================
function initMap() {
  if (!map) {
    map = L.map('map', { zoomControl: false }).setView(userLocation || [-3.73, -38.52], 13);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap &copy; CARTO',
      maxZoom: 19
    } ).addTo(map);
  }
}

function updateUI() {
  if (!map) initMap();
  updateMarkers();
  showNextStop();
  updateStats();
  updateRouteLines();
  updateSideList();
}

async function updateRouteLines() {
    // Limpa APENAS a rota da pr√≥xima entrega anterior
    if (nextDeliveryRouteLayer) map.removeLayer(nextDeliveryRouteLayer);

    // A l√≥gica da rota completa (routeLayer) foi movida para as fun√ß√µes de otimiza√ß√£o.
    // Esta fun√ß√£o agora √© mais leve e s√≥ cuida da rota din√¢mica para a pr√≥xima parada.

    const nextDelivery = deliveryData.find(d => d.status === "pendente");
    if (nextDelivery && userLocation) {
        const nextPoints = [userLocation, { lat: +nextDelivery.Latitude, lng: +nextDelivery.Longitude }];
        nextDeliveryRouteLayer = await drawRoute(nextPoints, { style: { color: "#ff6b35", weight: 7, opacity: 0.9, dashArray: '10, 5' } });
        if (nextDeliveryRouteLayer) nextDeliveryRouteLayer.addTo(map);
    }
}



function updateMarkers() {
  if (!map) return;
  markers.forEach(m => m.remove());
  markers = [];
  const next = deliveryData.find(d => d.status === "pendente");

  deliveryData.forEach(d => {
    const isNext = next && d.id === next.id;
    const color = d.status === "entregue" ? "#28a745" : d.status === "naoentregue" ? "#dc3545" : isNext ? "#ff6b35" : "#007bff";
    const size = isNext ? 38 : 30;
    const zIndex = isNext ? 1000 : 500;

    const iconHtml = `<div style="background-color:${color}; color:white; border-radius:50%; width:${size}px; height:${size}px; display:flex; align-items:center; justify-content:center; font-size:14px; font-weight:bold; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">${d.Sequence}</div>`;
    const marker = L.marker([+d.Latitude, +d.Longitude], {
      icon: L.divIcon({ className: '', html: iconHtml }),
      zIndexOffset: zIndex
    }).addTo(map);

    // --- CONTE√öDO DO POPUP COM BOT√ïES ---
    let popupContent = `
      <div style="min-width: 180px;">
        <b>Pacote <em>#${d.STOP}</em> (Parada: ${d.Sequence})</b>   <br>

        <small>${d['Destination Address'] || d['Endere√ßo'] || 'Sem endere√ßo'}</small>
        <hr style="margin: 8px 0;">
        <div style="display: flex; justify-content: space-around; align-items: center;">
            <button title="Entregue" onclick="changeStatus(${d.id}, 'entregue')" style="background: #10b981; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 14px;"><i class="fas fa-check"></i></button>
          <button title="N√£o Entregue" onclick="changeStatus(${d.id}, 'naoentregue')" style="background: #ef4444; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 14px;"><i class="fas fa-times"></i></button>
          <button title="Pendente" onclick="changeStatus(${d.id}, 'pendente')" style="background: #f59e0b; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; font-size: 14px;"><i class="fas fa-clock"></i></button>
        </div>
      </div>
    `;
    marker.bindPopup(popupContent);
    markers.push(marker);
  });
}

function showNextStop() {
  const next = deliveryData.find(d => d.status === "pendente");
  const nextStopBar = document.getElementById('nextStopBar');
  
  if (!next) {
    nextStopBar.classList.add("hidden");
    const allDone = deliveryData.every(d => d.status !== 'pendente');
    if (allDone && deliveryData.length > 0) showToast("üéâ Rota Conclu√≠da!", 'success');
    return;
  }

  const entreguesCount = deliveryData.filter(d => d.status === 'entregue').length;
  const naoEntreguesCount = deliveryData.filter(d => d.status === 'naoentregue').length;
  const total = deliveryData.length;
  
  const endereco = next['Destination Address'] || next['Endere√ßo'] || 'Endere√ßo n√£o dispon√≠vel';

  let infoHtml = `
    <div>
      <div class="flex justify-between items-center mb-1">
        <h3 class="text-lg font-bold text-gray-800"><span class="text-xs font-light text-gray-600">${entreguesCount + naoEntreguesCount} / ${total} Conclu√≠das</span> <br> Pr√≥xima Parada: ${next.Sequence} | Pacote: #${next.STOP}</h3>
      </div>
      <p class="text-sm text-gray-600">${endereco}</p>
    </div>
  `;
  
  document.getElementById('nextStopInfo').innerHTML = infoHtml;

  // --- ATUALIZA√á√ÉO DOS BOT√ïES ---
  document.getElementById('entregueText').textContent = `Entregue (${entreguesCount})`;
  document.getElementById('naoEntregueText').textContent = `N√£o Entregue (${naoEntreguesCount})`;
  // --- FIM DA ATUALIZA√á√ÉO ---

  nextStopBar.classList.remove("hidden");
}

function changeStatus(deliveryId, newStatus) {
  const delivery = deliveryData.find(d => d.id === deliveryId);
  if (delivery) {
    delivery.status = newStatus;
    const messages = {
      'entregue': { text: `‚úÖ Pacote #${delivery.STOP} marcado como Entregue!`, type: 'success' },
      'naoentregue': { text: `‚ùå Pacote #${delivery.STOP} marcado como N√£o Entregue`, type: 'warn' },
      'pendente': { text: `‚è∏Ô∏è Pacote #${delivery.STOP} marcado como Pendente`, type: 'info' }
    };
    if (messages[newStatus]) {
        showToast(messages[newStatus].text, messages[newStatus].type);
    }
    saveState();
    updateUI(); // Essencial para redesenhar tudo, incluindo a rota
  }
}

// --- FUN√á√ÉO markNext MODIFICADA ---
function markNext(status) {
  const next = deliveryData.find(d => d.status === "pendente");
  if (next) {
    // Reutiliza a nova fun√ß√£o para manter a l√≥gica centralizada
    changeStatus(next.id, status);
  }
}

function updateStats() {
  const total = deliveryData.length;
  const entregues = deliveryData.filter(d => d.status === 'entregue').length;
  const naoEntregues = deliveryData.filter(d => d.status === 'naoentregue').length;
  const pendentes = total - entregues - naoEntregues;
  const progress = total > 0 ? Math.round(((entregues + naoEntregues) / total) * 100) : 0;
  
  document.getElementById('routeStats').innerHTML = `
    <div class="space-y-2">
      <div class="flex justify-between"><span>Total:</span><span class="font-semibold">${total}</span></div>
      <div class="flex justify-between text-green-600"><span>Entregues:</span><span class="font-semibold">${entregues}</span></div>
      <div class="flex justify-between text-red-600"><span>N√£o Entregues:</span><span class="font-semibold">${naoEntregues}</span></div>
      <div class="flex justify-between text-yellow-600"><span>Pendentes:</span><span class="font-semibold">${pendentes}</span></div>
      <div class="mt-3 pt-2 border-t border-indigo-200">
        <div class="flex justify-between mb-1"><span class="text-sm font-medium">Progresso:</span><span class="text-sm font-semibold">${progress}%</span></div>
        <div class="w-full bg-gray-200 rounded-full h-2.5"><div class="bg-indigo-600 h-2.5 rounded-full" style="width: ${progress}%"></div></div>
      </div>
    </div>`;
}

function updateSideList() {
    document.getElementById('routeList').innerHTML = deliveryData.map(d => {
        const statusConfig = {
            entregue: { bg: 'bg-green-50 border-green-200', text: 'text-green-700', icon: 'fa-check-circle' },
            naoentregue: { bg: 'bg-red-50 border-red-200', text: 'text-red-700', icon: 'fa-times-circle' },
            pendente: { bg: 'bg-yellow-50 border-yellow-200', text: 'text-yellow-700', icon: 'fa-clock' }
        };
        const config = statusConfig[d.status] || statusConfig.pendente;
        
        // CORRE√á√ÉO: Procura por 'Destination Address' ou 'Endere√ßo'
        const endereco = d['Destination Address'] || d['Endere√ßo'] || 'Sem endere√ßo';

        return `
          <div class="p-3 rounded-lg mb-2 border ${config.bg} flex justify-between items-center">
            <div class="flex items-center space-x-3 overflow-hidden">
              <div class="w-10 h-10 bg-indigo-600 text-white rounded-full flex items-center justify-center text-base font-bold flex-shrink-0" title="Parada Otimizada ${d.Sequence}">
                ${d.Sequence}
              </div>
              <div>
                <span class="text-sm font-semibold text-gray-800 truncate block">Parada ${d.Sequence} | Pacote: #${d.STOP}</span>
                <span class="text-xs text-gray-500 truncate block">${endereco}</span>
              </div>
            </div>
            <div class="flex items-center space-x-2 flex-shrink-0">
              <i class="fas ${config.icon} ${config.text}"></i>
              <span class="${config.text} font-medium capitalize text-xs">${d.status.replace('naoentregue', 'n√£o entregue')}</span>
            </div>
          </div>`;
    }).join('');
}

// =================================================================================
// A√á√ïES DO USU√ÅRIO E EVENTOS
// =================================================================================
function markNext(status) {
  const next = deliveryData.find(d => d.status === "pendente");
  if (next) {
    next.status = status;
    const messages = {
      'entregue': { text: '‚úÖ Entrega Realizada!', type: 'success' },
      'naoentregue': { text: '‚ùå Entrega N√£o Realizada', type: 'warn' }
    };
    if (messages[status]) {
        showToast(messages[status].text, messages[status].type);
    }
    saveState();
    updateUI();
  }
}

function openNavigation() {
    const next = deliveryData.find(d => d.status === "pendente");
    if (next) {
        const url = `https://www.google.com/maps/dir/?api=1&destination=${next.Latitude},${next.Longitude}`;
        window.open(url, '_blank' );
    }
}

function startTracking() {
  if (!navigator.geolocation) return;
  const watchOptions = { enableHighAccuracy: true, timeout: 10000, maximumAge: 5000 };

  navigator.geolocation.watchPosition(pos => {
    userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    if (!userMarker) {
      const pulseIcon = L.divIcon({
        className: "",
        html: `<div class="relative"><div class="w-6 h-6 bg-blue-500 rounded-full border-4 border-white shadow-md"></div><div class="absolute inset-0 rounded-full bg-blue-400 opacity-50 animate-ping"></div></div>`
      });
      userMarker = L.marker([userLocation.lat, userLocation.lng], { icon: pulseIcon }).addTo(map).bindPopup("üìç Voc√™ est√° aqui");
    } else {
      userMarker.setLatLng([userLocation.lat, userLocation.lng]);
    }
    updateRouteLines();

    const nextDelivery = deliveryData.find(d => d.status === "pendente");
    if (nextDelivery) {
      const distanceToNext = haversine(userLocation, { lat: +nextDelivery.Latitude, lng: +nextDelivery.Longitude });
      if (distanceToNext < 0.5) { // Zoom autom√°tico a menos de 500m
        const bounds = L.latLngBounds([userLocation, { lat: +nextDelivery.Latitude, lng: +nextDelivery.Longitude }]);
        map.fitBounds(bounds, { padding: [80, 80], maxZoom: 17 });
      }
    }
  }, () => { showToast("N√£o foi poss√≠vel obter sua localiza√ß√£o em tempo real.", "error"); }, watchOptions);
}

function showMapControls(show) {
    const visibility = show ? 'remove' : 'add';
    document.getElementById('menuToggleBtn').classList[visibility]('hidden');
    document.getElementById('centerUserBtn').classList[visibility]('hidden');
    document.getElementById('reOptimizeBtn').classList[visibility]('hidden');
}

function toggleMenu(force = null) {
  const sideMenu = document.getElementById("sideMenu");
  const menuOverlay = document.getElementById("menuOverlay");
  // A linha 'optimizeInMenuBtn' foi removida
  const isOpen = !sideMenu.classList.contains("hidden");
  const shouldOpen = force !== null ? force : !isOpen;
  if (shouldOpen) {
    sideMenu.classList.remove("hidden");
    menuOverlay.classList.remove("hidden");
    setTimeout(() => sideMenu.classList.remove("-translate-x-full"), 10);
    // A linha 'optimizeInMenuBtn' foi removida
  } else {
    sideMenu.classList.add("-translate-x-full");
    menuOverlay.classList.add("hidden");
    setTimeout(() => sideMenu.classList.add("hidden"), 300);
  }
}

// =================================================================================
// FUN√á√ïES UTILIT√ÅRIAS
// =================================================================================
function haversine(pos1, pos2) {
  const R = 6371; // Raio da Terra em km
  const dLat = (pos2.lat - pos1.lat) * Math.PI / 180;
  const dLon = (pos2.lng - pos1.lng) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(pos1.lat * Math.PI / 180) * Math.cos(pos2.lat * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function showToast(message, type = 'info') {
  const toast = document.getElementById('toast');
  const toastMessage = document.getElementById('toastMessage');
  const toastIcon = document.getElementById('toastIcon');
  
  const icons = {
    info: 'fa-info-circle',
    success: 'fa-check-circle',
    warn: 'fa-exclamation-triangle',
    error: 'fa-times-circle'
  };
  toastIcon.className = `fas ${icons[type]} mr-3`;
  
  toastMessage.textContent = message;
  toast.classList.add('show');
  
  setTimeout(() => { toast.classList.remove('show'); }, 3000);
}

function showConfirmModal(title, message) {
  return new Promise((resolve) => {
    const modal = document.getElementById('confirmModal');
    document.getElementById('confirmTitle').textContent = title;
    document.getElementById('confirmMessage').innerHTML = message; // Usamos innerHTML para permitir quebras de linha com   


    modal.classList.remove('hidden');

    const okBtn = document.getElementById('confirmOkBtn');
    const cancelBtn = document.getElementById('confirmCancelBtn');

    const close = (decision) => {
      modal.classList.add('hidden');
      // Remove os event listeners para evitar m√∫ltiplos cliques em futuras chamadas
      okBtn.onclick = null;
      cancelBtn.onclick = null;
      resolve(decision);
    };

    okBtn.onclick = () => close(true);
    cancelBtn.onclick = () => close(false);
  });
}

// =================================================================================
// EVENT LISTENERS
// =================================================================================
document.getElementById("menuToggleBtn").addEventListener("click", () => toggleMenu());
document.getElementById("closeMenuBtn").addEventListener("click", () => toggleMenu(false));
document.getElementById("menuOverlay").addEventListener("click", () => toggleMenu(false));

document.getElementById("loadNewFileBtn").addEventListener("click", () => {
    if (confirm('Tem certeza que deseja recome√ßar? Todos os dados da rota atual ser√£o perdidos.')) {
        clearState();
    }
});

// --- OUVINTES DE EVENTOS CORRETOS PARA OS BOT√ïES FLUTUANTES ---
document.getElementById('reOptimizeBtn').addEventListener('click', reOptimizeFromCurrentLocation);

document.getElementById('centerUserBtn').addEventListener('click', () => {
    if (userLocation) {
        map.setView(userLocation, 16);
        showToast('üìç Centralizado na sua localiza√ß√£o', 'info');
    } else {
        showToast('Localiza√ß√£o n√£o dispon√≠vel', 'warn');
    }
});

// Fun√ß√µes para controlar o modal de progresso
function showProgressModal(text) {
  document.getElementById('progressText').textContent = text;
  document.getElementById('progressModal').classList.remove('hidden');
}

function hideProgressModal() {
  document.getElementById('progressModal').classList.add('hidden');
}

</script>
</body>
</html>
